# IAM Service Architecture - Event-Driven Permission Sync

## Обзор архитектуры

Система IAM построена на принципах Event-Driven Architecture с поддержкой lazy loading разрешений для внешних сервисов. Это обеспечивает высокую производительность, масштабируемость и консистентность данных в распределенной системе.

## Компоненты системы

### 1. IAM Core Service
- **База данных**: PostgreSQL с функциями для работы с разрешениями
- **API**: REST API для управления пользователями, группами, ролями
- **gRPC**: Сервисы для проверки и синхронизации разрешений
- **Outbox Pattern**: Надежная публикация событий

### 2. Event System
- **Outbox Table**: Хранение событий для надежной доставки
- **Event Triggers**: Автоматическая генерация событий при изменениях
- **Event Processing**: Обработка и публикация событий

### 3. Permission Sync Service
- **gRPC API**: Для внешних сервисов
- **Lazy Loading**: Загрузка разрешений по требованию
- **Caching**: Кэширование разрешений с TTL
- **Bulk Operations**: Массовые операции для производительности

### 4. External Services Integration
- **Event Consumption**: Получение событий от IAM
- **Permission Sync**: Синхронизация разрешений
- **Local Caching**: Локальное кэширование разрешений

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           IAM Service Architecture                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   REST API      │    │   gRPC API      │    │   Database      │
│   (Management)  │    │   (Permissions) │    │   (PostgreSQL)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            IAM Core Service                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   User Mgmt     │  │  Permission     │  │   Group Mgmt    │            │
│  │   Service       │  │  Service        │  │   Service       │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Database Layer                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   iam.user      │  │ security.object │  │ cluster.group   │            │
│  │   iam.role      │  │ security.field  │  │ cluster.group_  │            │
│  │   iam.territory │  │ security.permission_set │ member    │            │
│  │   iam.principal │  │ security.object_permissions           │            │
│  │   iam.identity  │  │ security.field_permissions            │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Event Generation                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Triggers      │  │  Event          │  │   Outbox        │            │
│  │   (Database)    │  │  Functions      │  │   Table         │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Event Processing                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Outbox        │  │   Event         │  │   Message       │            │
│  │   Worker        │  │   Publisher     │  │   Broker        │            │
│  └─────────────────┘  └─────────────────┘  │   (Kafka)       │            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       External Services                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Data Service  │  │   Order Service │  │   User Service  │            │
│  │                 │  │                 │  │                 │            │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │            │
│  │ │Event Handler│ │  │ │Event Handler│ │  │ │Event Handler│ │            │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │            │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │            │
│  │ │Permission   │ │  │ │Permission   │ │  │ │Permission   │ │            │
│  │ │Sync Client  │ │  │ │Sync Client  │ │  │ │Sync Client  │ │            │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │            │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │            │
│  │ │Local Cache  │ │  │ │Local Cache  │ │  │ │Local Cache  │ │            │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Создание/Изменение пользователя
```
1. REST API → IAM Core Service
2. Database Update → Event Trigger
3. Event Function → Outbox Table
4. Outbox Worker → Message Broker
5. External Services → Event Handler
6. Permission Sync Client → gRPC API
7. Local Cache Update
```

### 2. Изменение разрешений группы
```
1. REST API → Group Management
2. Database Update → Permission Triggers
3. Event Generation → Outbox
4. Event Processing → Kafka
5. External Services → Group Event Handler
6. Bulk Permission Sync → gRPC API
7. Cache Invalidation → Cache Update
```

### 3. Проверка разрешений
```
1. External Service → Local Cache Check
2. If not cached → gRPC Permission Check
3. Cache Update → Return Permission
4. If cached → Return Permission
```

## Ключевые принципы

### 1. Event-Driven Architecture
- **Асинхронность**: События обрабатываются асинхронно
- **Надежность**: Outbox Pattern обеспечивает надежную доставку
- **Масштабируемость**: Независимые сервисы могут масштабироваться отдельно

### 2. Lazy Loading
- **Производительность**: Разрешения загружаются только при необходимости
- **Кэширование**: Результаты кэшируются для повторного использования
- **Инкрементальность**: Поддержка инкрементальных обновлений

### 3. Multi-tenancy
- **Изоляция**: Полная изоляция данных между тенантами
- **Масштабирование**: Поддержка множественных тенантов
- **Безопасность**: Проверка прав доступа на уровне тенанта

### 4. Caching Strategy
- **L1 Cache**: Локальный кэш в каждом сервисе
- **L2 Cache**: Кэш на уровне базы данных
- **TTL**: Настраиваемое время жизни кэша
- **Invalidation**: Инвалидация при изменениях

## Технологический стек

### Backend
- **Go**: Основной язык разработки
- **PostgreSQL**: База данных с расширениями
- **gRPC**: Межсервисная коммуникация
- **REST API**: HTTP API для управления

### Event Processing
- **Outbox Pattern**: Надежная публикация событий
- **Kafka**: Message broker (планируется)
- **AsyncAPI**: Спецификация событий

### Caching
- **In-memory**: Локальное кэширование
- **Database**: Кэш на уровне БД
- **TTL**: Время жизни кэша

### Monitoring
- **Metrics**: Метрики производительности
- **Logging**: Структурированное логирование
- **Tracing**: Распределенный трейсинг

## Сценарии использования

### 1. Управление пользователями
- Создание пользователей администраторами
- Саморегистрация пользователей
- Обновление профилей пользователей
- Деактивация пользователей

### 2. Управление группами
- Создание групп на основе ролей
- Создание групп на основе территорий
- Добавление/удаление участников
- Изменение типов групп

### 3. Управление разрешениями
- Назначение разрешений группам
- Отзыв разрешений
- Объектные разрешения (CRUD)
- Полевые разрешения (чтение/запись)

### 4. Синхронизация разрешений
- Автоматическая синхронизация при событиях
- Периодическая синхронизация
- Массовая синхронизация групп
- Проверка изменений разрешений

## Производительность

### Оптимизации
- **Индексы**: Оптимизированные индексы БД
- **Кэширование**: Многоуровневое кэширование
- **Пакетная обработка**: Массовые операции
- **Асинхронность**: Асинхронная обработка событий

### Метрики
- **Latency**: Время отклика API
- **Throughput**: Количество запросов в секунду
- **Cache Hit Rate**: Эффективность кэширования
- **Event Processing Time**: Время обработки событий

## Безопасность

### Аутентификация
- **JWT токены**: Для REST API
- **gRPC метаданные**: Для межсервисной коммуникации
- **Тенант-изоляция**: Изоляция данных по тенантам

### Авторизация
- **RBAC**: Role-Based Access Control
- **Объектные разрешения**: CRUD на уровне объектов
- **Полевые разрешения**: Чтение/запись на уровне полей

### Аудит
- **Логирование**: Все операции логируются
- **События аудита**: Специальные события для аудита
- **Отслеживание изменений**: История изменений разрешений

## Масштабирование

### Горизонтальное
- **Микросервисы**: Независимое масштабирование сервисов
- **Балансировка**: Распределение нагрузки
- **Кластеризация**: Кластеры для высокой доступности

### Вертикальное
- **Ресурсы**: Увеличение ресурсов серверов
- **Оптимизация**: Оптимизация запросов и кэширования
- **Партиционирование**: Разделение данных

## Мониторинг и наблюдаемость

### Метрики
- **Prometheus**: Сбор метрик
- **Grafana**: Визуализация метрик
- **Alerting**: Уведомления о проблемах

### Логирование
- **Structured Logging**: JSON логи
- **Log Aggregation**: Централизованный сбор логов
- **Log Analysis**: Анализ логов

### Трейсинг
- **Jaeger**: Распределенный трейсинг
- **OpenTelemetry**: Стандарт трейсинга
- **Performance Analysis**: Анализ производительности

## Roadmap

### Краткосрочные цели
- ✅ Базовая архитектура IAM
- ✅ Event generation и outbox pattern
- ✅ gRPC API для синхронизации разрешений
- ✅ Примеры интеграции для внешних сервисов

### Среднесрочные цели
- 🔄 Kafka интеграция для событий
- 🔄 WebSocket для real-time обновлений
- 🔄 GraphQL API для гибких запросов
- 🔄 Redis для кэширования

### Долгосрочные цели
- 🔮 Машинное обучение для предсказания разрешений
- 🔮 Автоматическая оптимизация кэша
- 🔮 Multi-cloud deployment
- 🔮 Advanced analytics и отчетность

## Заключение

Представленная архитектура обеспечивает:

1. **Высокую производительность** через многоуровневое кэширование
2. **Масштабируемость** через микросервисную архитектуру
3. **Надежность** через Event-Driven Architecture и Outbox Pattern
4. **Гибкость** через lazy loading и инкрементальную синхронизацию
5. **Безопасность** через multi-tenancy и детализированные разрешения

Система готова к использованию в production среде и может быть легко расширена для новых требований.
